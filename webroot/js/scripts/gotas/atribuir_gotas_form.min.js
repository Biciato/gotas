$(document).ready(function(){$("#parametro").focus();let scanner;var canvas=null;var canvasContext=null;var video=null;$(".user-btn-proceed").prop('disabled',!0);$(".user-btn-proceed").on('click',function(){$(".user-result").hide(500);$(".video-capture-gotas-user-select-container").hide()
var estado=$("#estado_funcionario").val();if(estado!="MG"){startQRCodeCapture()}else{startScanCapture("video-gotas-capture-container","video-gotas-capture","canvas-cam-gotas")}});$("#usuarios_id").change(function(){var interval=0;var retries=0;interval=setInterval(function(){if($("#usuarios_id").val()!=undefined&&$("#usuarios_id").val()>0){$(".user-btn-proceed").removeClass('disabled');$(".user-btn-proceed").prop('disabled',!1);clearInterval(interval)}},250)});$("#parametro").on('keyup',function(event){if(event.keyCode==13){$("#usuarios_id").change()}});$("#searchUsuario").on('click',function(){$("#usuarios_id").change()});var startQRCodeCapture=function(){$(".group-capture-qr-code").show();$(".video-gotas-scanning-container").show();$(".qr_code_reader").focus();$(".qr_code_reader").val(null)}
var stopQRCodeCapture=function(){$(".video-gotas-scanning-container").hide();$(".group-capture-qr-code").hide()}
var startScanCapture=function(regionCapture,videoElement,canvasElement){$("."+regionCapture).show();video=null;video=document.querySelector("#"+videoElement);navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia;var hdConstraints={video:{optional:[{minWidth:320},{minWidth:640},{minWidth:1024},{minWidth:1280},{minWidth:1920},{minWidth:2560},],},audio:!1};if(navigator.getUserMedia){navigator.getUserMedia(hdConstraints,handleVideo,videoError)}
function handleVideo(stream){window.localStream=stream;video.src=window.URL.createObjectURL(stream)}
function videoError(e){}};var stopCamRecording=function(){var interval=0;var retries=0;interval=setInterval(function(){if(window.localStream!==undefined){window.localStream.getVideoTracks()[0].stop()}
clearInterval(interval)},1000)}
var stopScanDocument=function(){stopCamRecording();$(".group-video-capture").hide()};$(".atalhos").on('click',function(){stopScanDocument();resetLayout()});$(".qr_code_reader").on('keydown',function(event){if(event.keyCode==13){populateFuelWords(this.value.trim())}});var populateFuelWords=function(url){callLoaderAnimation();$.ajax({type:"post",url:"/Gotas/getGotasByCliente",data:JSON.stringify({clientes_id:$("#clientes_id").val()}),beforeSend:function(xhr){xhr.setRequestHeader("Accept","application/json");xhr.setRequestHeader("Content-Type","application/json; charset=UTF-8")},error:function(response){console.log(response);callModalError(response.responseText);$(".qr_code_reader").val('')}}).done(function(result){var fuelWords=result.gotas;if(url!=undefined){checkPreviousCoupon(url,fuelWords)}else{closeLoaderAnimation()}
$(".qr_code_reader").val('')})};var checkPreviousCoupon=function(url,fuelWords){var chave_nfe_start='chNFe=';var chave_nfe_start_index=url.indexOf(chave_nfe_start)+chave_nfe_start.length;var chave_nfe_end_index=url.indexOf('&',chave_nfe_start_index);var chave_nfe=url.substr(chave_nfe_start_index,chave_nfe_end_index-chave_nfe_start_index);var estado_nfe=url.substr(url.indexOf('sefaz.')+'sefaz.'.length,2).toUpperCase();var data={chave_nfe:chave_nfe,estado_nfe:estado_nfe};$.ajax({type:"post",url:"/PontuacoesComprovantes/findTaxCoupon",data:JSON.stringify(data),beforeSend:function(xhr){xhr.setRequestHeader("Accept","application/json");xhr.setRequestHeader("Content-Type","application/json; charset=UTF-8")},error:function(response){console.log(response);closeLoaderAnimation()}}).done(function(result){if(result.found){callModalError(result.message)}else{if(!checkURLConsistency(url)){saveTaxCoupon(url)}else{closeLoaderAnimation()}}})}
var saveTaxCoupon=function(url){var urlToSave=url;var chave_nfe_start='chNFe=';var chave_nfe_start_index=url.indexOf(chave_nfe_start)+chave_nfe_start.length;var chave_nfe_end_index=url.indexOf('&',chave_nfe_start_index);var chave_nfe=url.substr(chave_nfe_start_index,chave_nfe_end_index-chave_nfe_start_index);var estado_nfe=url.substr(url.indexOf('sefaz.')+'sefaz.'.length,2).toUpperCase();$.ajax({type:"POST",url:"/PontuacoesComprovantes/saveTaxCoupon",data:JSON.stringify({url:urlToSave,clientes_id:$("#clientes_id").val(),usuarios_id:$("#usuarios_id").val(),funcionarios_id:$("#funcionarios_id").val(),chave_nfe:chave_nfe,estado_nfe:estado_nfe}),beforeSend:function(xhr){xhr.setRequestHeader("Accept","application/json");xhr.setRequestHeader("Content-Type","application/json; charset=UTF-8")},error:function(response){console.log(response);closeLoaderAnimation();callModalError(response.responseText)}}).done(function(result){if(result.success){var content=prepareContentPontuacoesDisplay(result.data);callModalSave(content);resetLayout()}else{callModalError(result.message)}
closeLoaderAnimation()})}
var checkURLConsistency=function(url){var arrayConsistency=[{key:'chNFe',size:44,fixedSize:!0,isOptional:!1,content:null,index:0,},{key:'nVersao',size:3,fixedSize:!0,isOptional:!1,content:null,index:0,},{key:'tpAmb',size:1,fixedSize:!0,isOptional:!1,content:null,index:0,},{key:'cDest',size:3,fixedSize:!1,isOptional:!0,content:null,index:0,},{key:'dhEmi',size:50,fixedSize:!1,isOptional:!1,content:null,index:0,},{key:'vNF',size:15,fixedSize:!1,isOptional:!1,content:null,index:0,},{key:'vICMS',size:15,fixedSize:!1,isOptional:!1,content:null,index:0,},{key:'digVal',size:56,fixedSize:!0,isOptional:!1,content:null,index:0,},{key:'cIdToken',size:6,fixedSize:!0,isOptional:!1,content:null,index:0,},{key:'cHashQRCode',size:40,fixedSize:!0,isOptional:!1,content:null,index:0,}];var hasErrors=!1;var arrayErrors=[];$.each(arrayConsistency,function(index,value){console.log(value);var key=value.key+'=';var keyIndex=url.indexOf(key);value.index=keyIndex+key.length;if(!value.isOptional){var errorType="";if(keyIndex==-1){errorType="Campo <strong>"+value.key+"</strong> do QR Code deve ser informado"}else{var indexEnd=url.indexOf("&",value.index);if(value.index>indexEnd){indexEnd=url.length}
var length=indexEnd-value.index;value.content=url.substr(value.index,indexEnd-value.index);var containsBlank=value.content.indexOf(" ");if(containsBlank==-1){if(value.fixedSize){if(length!=value.size){errorType="Campo <strong>"+value.key+"</strong> do QR Code deve conter "+value.size+" bytes"}}}else{errorType="Campo <strong>"+value.key+"</strong> contêm espaço em branco."}}
if(errorType.length>0){value.error=errorType;arrayErrors.push(value);hasErrors=!0}}});if(arrayErrors.length>0){var hasErrorsString="";$.each(arrayErrors,function(index,value){hasErrorsString+=value.error+"<br />"});callModalError(`O QR Code informado não está gerado conforme os padrões pré- estabelecidos da SEFAZ. <br />
                        Será necessário realizar a importação manual. <p> Erros encontrados na URL do QR Code (para informar aos desenvolvedores): </p> `+hasErrorsString)}
return arrayErrors.length>0}
$(".take-scanner-snapshot").click(function(){manualInstascanReceipt()});var manualInstascanReceipt=function(){stopQRCodeCapture();startScanCapture("video-receipt-capture-container","video-receipt-capture","canvas-instascan-gotas")}
$(".capture-receipt-snapshot").on('click',function(){canvas=$("#canvas-instascan-gotas")[0];var height=canvas.height;var width=canvas.width;var canvasContext=canvas.getContext('2d');canvasContext.drawImage(video,0,0,width,height);$(".video-receipt-capture-container").hide();$(".video-receipt-captured-region").fadeIn(500);stopScanDocument()});$(".video-receipt-capture-again").click(function(){canvas=$("#canvas-instascan-gotas")[0];var height=canvas.clientHeight;var width=canvas.clientWidth;var canvasContext=canvas.getContext('2d');canvasContext.clearRect(0,0,canvas.width,canvas.height);canvasContext.restore();$(".video-receipt-captured-region").hide();$(".video-receipt-capture-container").fadeIn(500);startScanCapture("video-receipt-capture-container","video-receipt-capture","canvas-instascan-gotas")});$(".store-receipt-image").on('click',function(){var canvas=$("#canvas-instascan-gotas")[0];var img=canvas.toDataURL('image/jpeg');getNewNameForImage(img)});var getNewNameForImage=function(imageData){$.ajax({url:"/PontuacoesComprovantes/getNewReceiptName",type:"POST",beforeSend:function(xhr){xhr.setRequestHeader("Accept","application/json");xhr.setRequestHeader("Content-Type","application/json; charset=UTF-8")},success:function(response){console.log(response)},error:function(response){console.log(response.responseText)}}).done(function(result){saveImageReceipt(imageData,result.nome_img)})};var saveImageReceipt=function(imageData,imageName){callLoaderAnimation();var data={image_name:imageName,image:imageData,_Token:document.cookie.substr(document.cookie.indexOf("csrfToken=")+"csrfToken=".length)};$.ajax({url:"/PontuacoesComprovantes/saveImageReceipt",type:"POST",data:JSON.stringify(data),beforeSend:function(xhr){xhr.setRequestHeader("Accept","application/json");xhr.setRequestHeader("Content-Type","application/json; charset=UTF-8")},error:function(response){console.log(response.responseText);closeLoaderAnimation()}}).done(function(result){closeLoaderAnimation();if(result.success){var estado=$("#estado_funcionario").val();if(estado!="MG"){$(".video-receipt-captured-region").hide();$(".gotas-instascan-manual-insert").fadeIn(500)}else{populateFuelWords();$(".video-gotas-captured-region").hide();$(".gotas-camera-manual-insert").fadeIn(500)}
$("#image_name").val(imageName)}})};$(".video-gotas-capture-container .video-gotas-snapshot").on('click',function(){canvas=$("#canvas-cam-gotas")[0];var height=canvas.height;var width=canvas.width;var canvasContext=canvas.getContext('2d');canvasContext.drawImage(video,0,0,width,height);$(".video-gotas-capture-container").hide();$(".video-gotas-captured-region").fadeIn(500);stopScanDocument()});$(".video-gotas-capture-again").click(function(){canvas=$("#canvas-cam-gotas")[0];var height=canvas.clientHeight;var width=canvas.clientWidth;var canvasContext=canvas.getContext('2d');canvasContext.clearRect(0,0,canvas.width,canvas.height);canvasContext.restore();$(".video-gotas-captured-region").hide();$(".video-gotas-capture-container").fadeIn(500);startScanCapture("video-gotas-capture-container","video-gotas-capture","canvas-cam-gotas")});$(".store-gotas-image").on('click',function(){var canvas=$("#canvas-cam-gotas")[0];var img=canvas.toDataURL('image/jpeg');getNewNameForImage(img)})});var resetLayout=function(){$(".group-video-capture-gotas").show();$("#parametro").val(null);$("#parametro").focus();$(".user-query-region").show();$(".group-capture-qr-code").hide();$(".video-receipt-capture-container").hide();$(".video-receipt-captured-region").hide();$(".video-gotas-capture-container").hide();$(".video-gotas-captured-region").hide();$(".video-gotas-scanning-container").hide();$(".qr_code_reader").val(null);$(".gotas-instascan-manual-insert").hide();$(".gotas-camera-manual-insert").hide()}