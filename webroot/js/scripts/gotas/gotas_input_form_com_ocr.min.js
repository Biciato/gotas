$(document).ready(function(){if($("#estado_funcionario").val()!='MG'){callLoaderAnimation();$.ajax({type:"post",url:"/Gotas/getGotasByCliente",data:JSON.stringify({clientes_id:$("#clientes_id").val()}),beforeSend:function(xhr){xhr.setRequestHeader("Accept","application/json");xhr.setRequestHeader("Content-Type","application/json; charset=UTF-8")},error:function(response){console.log(response);closeLoaderAnimation()}}).done(function(result){closeLoaderAnimation();if(result.gotas!==undefined&&result.gotas.length>0){arrayGotas.set(result.gotas);$(".gotas-instascan-manual-insert #list_parametros").append($("<option>"));$.each(result.gotas,function(index,value){$(".gotas-instascan-manual-insert #list_parametros").append($("<option>",{value:value.gotas_id,text:value.nome_parametro}))})}else{callModalError("Não há gotas configuradas para o estabelecimento, não será possível realizar a <strong>Atribuição de Gotas!</strong> <br /> \
                Comunique seu gestor.")}})}
$(".gotas-instascan-manual-insert #chave_nfe").mask('9999 9999 9999 9999 9999 9999 9999 9999 9999 9999 9999');$(".gotas-instascan-manual-insert #list_parametros").prop('disabled',!0);$(".gotas-instascan-manual-insert #quantidade_input").mask("####.##",{reverse:!0});$(".gotas-instascan-manual-insert #quantidade_input").on('blur',function(){if(this.value.indexOf('.')==-1){if(parseInt(this.value)<=9){this.value='0.0'+parseInt(this.value)}else if(parseInt(this.value)<=99){this.value='0.'+parseInt(this.value)}}});$(".gotas-instascan-manual-insert .save-receipt-button").prop('disabled',!0);var chave_nfe_valid={isValid:!1,get:function(){return this.isValid},set:function(value){this.isValid=value}};var arrayParametrosGravar={array:[],get:function(){return this.array},set:function(array){this.array=array},add:function(item){this.array.push(item)},remove:function(key){var arrayToRemove=[];$.each(this.array,function(index,value){if(value.key!=key){arrayToRemove.push(value)}})
this.array=arrayToRemove},clear:function(){this.array=[]}};var arrayGotas={array:[],get:function(){return this.array},findByKey:function(key){var item=$.grep(this.array,function(value,index){if(value.gotas_id==key)
return value});return item[0]},set:function(array){this.array=array}};$(".gotas-instascan-manual-insert .call-modal-how-it-works").on('click',function(){var id=$(this.attributes['target-id']).val();callHowItWorks(id)});var initializeSelectClicks=function(){$(".gotas-instascan-manual-insert .select-button").on('click',function(){var key=parseInt($(this)[0].attributes.value.value);arrayParametrosGravar.remove(key);updateTableParametrosGravar()})}
$(".gotas-instascan-manual-insert #chave_nfe").on('keydown',function(data){if(!isNaN(data.key)){return}});var checkTaxCouponRepeated=function(function_execute){var chave_nfe=$(".gotas-instascan-manual-insert #chave_nfe").val();var chave_nfe_original=chave_nfe;while(chave_nfe.indexOf(" ")!=-1){chave_nfe=chave_nfe.replace(" ","")}
if(chave_nfe_original.length<54){$(".gotas-instascan-manual-insert #list_parametros").attr('disabled',!0)}else{callLoaderAnimation();var data={chave_nfe:chave_nfe,estado_nfe:$("#estado_funcionario").val(),clientes_id:$("#clientes_id").val()};$.ajax({type:"POST",url:"/PontuacoesComprovantes/findTaxCoupon",data:JSON.stringify(data),error:function(response){console.log(response)}}).done(function(result){if(result.found){callModalError("Este registro já foi importado previamente, não sendo possível a importação!");$(".gotas-instascan-manual-insert .save-receipt-button").attr('disabled',!0);$(".gotas-instascan-manual-insert #list_parametros").val(null);$(".gotas-instascan-manual-insert #list_parametros").attr('disabled',!0);$(".gotas-instascan-manual-insert #list_parametros").change()}else{$(".gotas-instascan-manual-insert #list_parametros").attr('disabled',!1);if(arrayParametrosGravar.get().length>0){$(".gotas-instascan-manual-insert .save-receipt-button").attr('disabled',!1);if(function_execute!==undefined){function_execute()}}}
closeLoaderAnimation()})}}
$(".gotas-instascan-manual-insert #chave_nfe").on('keyup',function(data){enableSelectParameter();checkTaxCouponRepeated()});var enableSelectParameter=function(){if($(".gotas-instascan-manual-insert #list_parametros").val()!==""&&$(".gotas-instascan-manual-insert #chave_nfe").val().length==54){$(".gotas-instascan-manual-insert .select-parameter").prop('disabled',!1)}else{$(".gotas-instascan-manual-insert .select-parameter").prop('disabled',!0)}}
$(".gotas-instascan-manual-insert #list_parametros").on('change',function(){var key=$("#list_parametros").val();var parameter=arrayGotas.findByKey(key);parameter==undefined?$(".gotas-instascan-manual-insert #quantidade_input").prop('disabled',!0):$(".gotas-instascan-manual-insert #quantidade_input").prop('disabled',!1);delete parameter});$(".gotas-instascan-manual-insert #list_parametros").on('change',function(){enableSelectParameter()});$(".gotas-instascan-manual-insert #quantidade_input").on('keyup',function(){if($(this).val()!=""){$(".gotas-instascan-manual-insert .add-parameter").prop('disabled',!1)}else{$(".gotas-instascan-manual-insert .add-parameter").prop('disabled',!0)}});$(".gotas-instascan-manual-insert .add-parameter").prop('disabled',!0);$(".gotas-instascan-manual-insert .add-parameter").on('click',function(){var key=$(".gotas-instascan-manual-insert #list_parametros").val();var item=arrayGotas.findByKey(key);var itemToAdd={key:arrayParametrosGravar.get().length,id:item.id,gotas_id:item.gotas_id,nome_parametro:item.nome_parametro,quantidade_multiplicador:parseFloat($(".gotas-instascan-manual-insert #quantidade_input").val())};arrayParametrosGravar.add(itemToAdd);updateTableParametrosGravar()});var updateTableParametrosGravar=function(){$(".gotas-instascan-manual-insert .gotas-products-table >tbody").html('');if(arrayParametrosGravar.get().length>0){$(".gotas-instascan-manual-insert .save-receipt-button").prop('disabled',!1)}else{$(".gotas-instascan-manual-insert .save-receipt-button").prop('disabled',!0)}
$.each(arrayParametrosGravar.get(),function(index,value){var html="<tr><td>"+value.nome_parametro+"</td><td>"+value.quantidade_multiplicador+"</td><td>"+"<div class='btn btn-danger btn-xs select-button' value='"+value.key+"'>Remover</div>"+"</td></tr>";$(".gotas-instascan-manual-insert .gotas-products-table ").append(html)});initializeSelectClicks()};$(".gotas-instascan-manual-insert .save-receipt-button").on('click',function(){checkTaxCouponRepeated(saveReceipt)});var saveReceipt=function(){var data=[];$.each(arrayParametrosGravar.get(),function(index,value){value.clientes_id=$("#clientes_id").val();value.usuarios_id=$("#usuarios_id").val();var chave_nfe=$(".gotas-instascan-manual-insert #chave_nfe").val();while(chave_nfe.indexOf(" ")!=-1){chave_nfe=chave_nfe.replace(" ","")}
value.chave_nfe=chave_nfe;value.nome_img=$("#image_name").val();value.estado_nfe=$("#estado_funcionario").val();data.push(value)});callLoaderAnimation();$.ajax({type:"POST",url:"/PontuacoesComprovantes/saveManualReceipt",data:JSON.stringify({data:data}),beforeSend:function(xhr){xhr.setRequestHeader("Accept","application/json");xhr.setRequestHeader("Content-Type","application/json; charset=UTF-8")},error:function(response){console.log(response);callModalError(response.responseText)}}).done(function(result){console.log(result);closeLoaderAnimation();if(result.success){callModalSave();$(".gotas-instascan-manual-insert #chave_nfe").val(null);$(".gotas-instascan-manual-insert #list_parametros").val(0);$(".gotas-instascan-manual-insert #list_parametros").change();$(".gotas-instascan-manual-insert #quantidade_input").val(null);arrayParametrosGravar.clear();updateTableParametrosGravar();resetLayout()}else{callModalError("Houve um erro no processamento.")}})}})